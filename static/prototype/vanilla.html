<html>
  <head>
    <title>Vanilla Prototype</title>
    <link rel="stylesheet" href="styling.css">
    <script type="text/javascript">
      var selection = null;

      function noMods(eve) {
          return !(eve.altKey || eve.ctrlKey || eve.metaKey || eve.shiftKey);
      }

      // There's probably a more efficient way to do this...
      function exactMods(eve, mods) {
          var posMods = ['alt', 'ctrl', 'meta', 'shift'];
          var ret = 1;
          for (var i = 0; i < posMods.length; ++i) {
              var mod = posMods[i];
              if (mods.includes(mod)) {
                  //Has to be set
                  ret &= eve[mod + 'Key'];
              } else {
                  //Has to not be set
                  ret &= !(eve[mod + 'Key']);
              }
          }
          return ret;
      }

      function keyHandler(eve) {
          //Regular Typing, append to selected cell
          if ((noMods(eve) || exactMods(eve, ['shift'])) && (
              (eve.keyCode > 47 && eve.keyCode < 58) ||    // numbers
              eve.keyCode == 32 ||                         // spacebar
              (eve.keyCode > 64 && eve.keyCode < 91) ||    // letters
              (eve.keyCode > 95 && eve.keyCode < 112) ||   // numpad
              (eve.keyCode > 185 && eve.keyCode < 193) ||  // ;=,-./`
              (eve.keyCode > 218 && eve.keyCode < 223))) {  // [\]'
              appendSelection(eve.key);
          //Backspace (no modifiers)
          } else if (noMods(eve) && eve.keyCode === 8) {
              backspace();
          //\n (no modifiers)
          } else if (noMods(eve) && eve.keyCode === 13) {
              addAndSelectAfter(selection);
          //\n (+shift)
          } else if (exactMods(eve, ['shift']) && eve.keyCode === 13) {
              //TODO: Make multi line in cell
          //Up (no modifiers)
          } else if (noMods(eve) && eve.keyCode === 38) {
              if (selection.previousElementSibling) {
                  selection = select(selection.previousElementSibling);
              } else {
                  addAndSelectBefore(selection);
              }
          //Down (no modifiers)
          } else if (noMods(eve) && eve.keyCode === 40) {
              if (selection.nextElementSibling) {
                  selection = select(selection.nextElementSibling);
              } else {
                  addAndSelectAfter(selection);
              }
          //Log what falls through
          } else {
              console.log(eve);
          }
      }

      function styleSelect(div) {
          div.style.borderWidth = 2;
          div.style.margin = 1;
          div.style.borderColor = '#000080';
          return div;
      }

      function select(e) {
          if (selection) {
              unselect(selection);
          }
          styleSelect(e);
          return e;
      }

      function styleUnselect(div) {
          div.style.borderWidth = 1;
          div.style.margin = 2;
          div.style.borderColor = '#BEBEBE';
          return div;
      }

      function unselect(e) {
          styleUnselect(e);
          if (e.innerText === "") {
              e.remove();
          }
          selection = null;
      }

      function backspace() {
          if (selection) {
              //Is a div, has text, take off the last character
              if (selection.innerText !== "") {
                  selection.innerText = selection.innerText.slice(0, -1);
              } else {
                  //Remove until there's only a blank element
                  if (selection.previousElementSibling !== null) {
                      toSelect = selection.previousElementSibling;
                      selection.remove();
                      selection = select(toSelect);
                  } else if (selection.nextElementSibling !== null) {
                      toSelect = selection.nextElementSibling;
                      selection.remove();
                      selection = select(toSelect);
                  }
              }
          }
      }

      function newDiv() {
          var div = document.createElement('div');
          div.classList.add('list-element');
          return div;
      }

      function addAndSelectAfter(e) {
          var div = newDiv();
          e.after(div);
          selection = select(div);
      }

      function addAndSelectBefore(e) {
          var div = newDiv();
          e.before(div);
          selection = select(div);
      }

      function appendSelection(s) {
          //Append to the selection
          selection.innerHTML += s;
      }

      function init() {
          document.addEventListener('keydown', keyHandler);
          var div = newDiv();
          document.getElementById("list1").appendChild(div);
          selection = select(div);
      }
    </script>
  </head>
  <body onload="init()">
    <div id="container" class="list-outer">
      <div id="list1" class="list">
      </div>
    </div>
  </body>
</html>
