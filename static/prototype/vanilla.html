<html>
  <head>
    <title>Vanilla Prototype</title>
    <link rel="stylesheet" href="styling.css">
    <script type="text/javascript">
      var cursor = null;
      var selection = null;

      function keyHandler(eve) {
          if (eve.ctrlKey || eve.altKey) {
              //TODO
          } else if ((eve.keyCode > 47 && eve.keyCode < 58) ||    // numbers
                     eve.keyCode == 32 ||                         // spacebar
                     (eve.keyCode > 64 && eve.keyCode < 91) ||    // letters
                     (eve.keyCode > 95 && eve.keyCode < 112) ||   // numpad
                     (eve.keyCode > 185 && eve.keyCode < 193) ||  // ;=,-./`
                     (eve.keyCode > 218 && eve.keyCode < 223)) {  // [\]'
              appendSelection(eve.key);
          } else if (eve.keyCode === 8) { //Backspace
              backspace();
          } else if (eve.keyCode === 13) { //\n
              // Or should we insert a new element after the current?
              if (selection.nextElementSibling) {
                  selection = select(selection.nextElementSibling);
              }
          } else if (eve.keyCode === 38) { //Up
              if (selection.previousElementSibling) {
                  selection = select(selection.previousElementSibling);
              }
          } else if (eve.keyCode === 40) { //Down
              if (selection.nextElementSibling) {
                  selection = select(selection.nextElementSibling);
              }
          } else {
              console.log(eve);
          }
      }

      function styleSelect(div) {
          div.style.borderWidth = 2;
          div.style.margin = 1;
          div.style.borderColor = '#000080';
          return div;
      }

      function select(e) {
          if (selection) {
              unselect(selection);
          }
          styleSelect(e);
          return e;
      }

      function styleUnselect(div) {
          div.style.borderWidth = 1;
          div.style.margin = 2;
          div.style.borderColor = '#BEBEBE';
          return div;
      }

      function unselect(e) {
          styleUnselect(e);
          selection = null;
      }

      function backspace() {
          if (selection === cursor) {
              //Try to select the one before
              if (cursor !== cursor.parentElement.firstElementChild) {
                  selection = select(cursor.previousSibling);
              }
          } else if (selection) {
              //Is a div, has text, take off the last character
              if (selection.innerText !== "") {
                  selection.innerText = selection.innerText.slice(0, -1);
              } else {
                  //Remove the node and either select the previous
                  // or the cursor.
                  var toSelect = cursor;
                  if (selection.previousElementSibling !== null) {
                      toSelect = selection.previousSibling;
                  }
                  selection.remove();
                  selection = select(toSelect);
              }
          }
      }

      function appendSelection(s) {
          if (!selection || selection === cursor) {
              //Add a new element right above the cursor,
              // show that it's selected
              var div = document.createElement('div');
              div.classList.add('list-element');
              cursor.parentElement.insertBefore(div, cursor);
              selection = select(div);
          }
          //Append to the selection
          selection.innerHTML += s;
      }

      function init() {
          cursor = selection = document.getElementById("cursor");
          selection = select(cursor);
          document.addEventListener('keydown', keyHandler);
      }
    </script>
  </head>
  <body onload="init()">
    <div id="container" class="list-outer">
      <div id="list1" class="list">
        <div id="cursor" class="list-end-cursor"></div>
      </div>
    </div>
  </body>
</html>
